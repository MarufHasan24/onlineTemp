<!DOCTYPE html>
<!--Code created by Maruf hasan-->
<!--Date: 31 July, 2024-->
<html>
<meta name="author" content="Maruf hasan" />
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<meta content="width=device-width, initial-scale=1" name="viewport" />

<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="/assets/styles/common.css">
    <link rel="stylesheet" href="/assets/styles/dashboard.css">
    <script src="/assets/scripts/tools.js"></script>
    <script src="/assets/scripts/dashboard.js"></script>
    <header>
        <h1>Welcome to Dashboard</h1>
        <ul class="menu">
            <li><a href="/">Home</a></li>
            <li><a href="/editathon?key=<%= key %>">Ediathon</a></li>
            <li><a href="javascript:void" onclick="history.back()">Go back</a></li>
            <% if(key) {%>
                <li><a href="javascript:void" onclick="deleteKey('<%=key%>')">Delete key</a></li>
                <% } %>
        </ul>
    </header>
</head>

<body>
    <iframe src="/background.html" frameborder="0"></iframe>
    <div class="container">
        <% if (!key && !pass) { %>
            <!-- If retake is true, ask for both key and password -->
            <section class="checking">
                <h2>Enter Your key and Password</h2>
                <form>
                    <input type="text" name="key" placeholder="key">
                    <input type="password" name="pass" placeholder="Password">
                    <button onclick="submit()" type="submit">Submit</button>
                </form>
            </section>
            <script>
                function submit() {
                    fetch("/dashboard", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            key: document.querySelector("input[name='key']").value,
                            password: document.querySelector("input[name='pass']").value,
                            action: "login"
                        }),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data && data.key) {
                                location.replace("/dashboard?key=" + data.key);
                            } else {
                                console.log(data)
                            }
                        });
                }
            </script>
            <% } else if(key && !pass){ %>
                <!-- If only the key is provided, ask for the password -->
                <section class="checking">
                    <h2>Please Enter Your Password</h2>
                    <form id="passwordForm">
                        <input type="hidden" name="key" value="<%= key %>">
                        <input type="password" name="pass" placeholder="Password">
                        <button type="submit">Submit</button>
                        <p id="errorMessage" style="color: red; display: none;">Incorrect password. Please try
                            again.</p>
                    </form>
                </section>
                <script>
                    document.getElementById('passwordForm').addEventListener('submit', function (event) {
                        event.preventDefault(); // Prevent default form submission

                        const enteredPassword = event.target.pass.value;
                        const correctPassword = '<%= checkpass %>'; // Replace with actual logic to get the correct password
                        const errorMessage = document.getElementById('errorMessage');

                        if (enteredPassword === correctPassword) {
                            const key = event.target.key.value;
                            const queryString = `?key=${encodeURIComponent(key)}&pass=${encodeURIComponent(enteredPassword)}`;
                            window.location.href = '/dashboard' + queryString;
                        } else {
                            errorMessage.style.display = 'block';
                        }
                    });
                </script>
                <% } else { %>
                    <!-- normal -->
                    <div id="overlay"></div>
                    <div id="popupMessage" class="popupMessage">
                        <p>Incorrect password. Please try again.</p>
                        <button id="closePopup">OK</button>
                    </div>
                    <%if (pass !==checkpass) {%>
                        <script>
                            // Show custom pop-up
                            document.getElementById('overlay').style.display = 'block';
                            document.getElementById('popupMessage').style.display = 'block';

                            // Close pop-up and redirect when button is clicked
                            document.getElementById('closePopup').addEventListener('click', function () {
                                document.getElementById('overlay').style.display = 'none';
                                document.getElementById('popupMessage').style.display = 'none';
                                window.location.href = "/dashboard?key=" + encodeURIComponent('<%= key %>');
                            });
                        </script>
                        <% } else { %>
                            <%if(data && data.data && Object.keys(data.data).length) { %>
                                <script>
                                    const userdata = JSON.parse(validateStr('<%=jsondata%>'));
                                    if (userdata) {
                                        console.log(userdata)
                                    }
                                </script>
                                <h1>
                                    <%=data.data.title%>
                                </h1>
                                <!-- main works go here -->
                                <!-- Countdown section -->
                                <iframe class="countdown" src="./countdown.html" id="countdown"
                                    frameborder="0"></iframe>
                                <script>
                                    // Ensure the iframe is fully loaded before accessing its content
                                    document.getElementById('countdown').onload = function () {
                                        // Access the countdown function inside the iframe's content window
                                        this.contentWindow.countdown(
                                            Date.parse('<%=data.data.end_date%>' + ' ' + '<%=data.data.end_time%>'), Date.parse('<%=data.data.start_date%>' + ' ' + '<%=data.data.start_time%>')
                                        );
                                    };
                                </script>
                                <!-- CountDown section end -->
                                <!-- Statistic section -->
                                <div class="stats">
                                    <div class="card small">
                                        <h2>
                                            <%=data.data.pagecount%>
                                        </h2>
                                        <p>Total submission</p>
                                    </div>
                                    <div class="card small">
                                        <h2>
                                            <%=data.data.usercount%>
                                        </h2>
                                        <p>Total Submitor</p>
                                    </div>
                                    <div class="card small">
                                        <h2>
                                            <%=Object.keys(data.data.jurries_list).length%>
                                        </h2>
                                        <p>Total Jurries. Page/Jurries have to review is about :
                                            <b>
                                                <%=Math.ceil((Number(data.data.pagecount) - Number(data.data.reviewed))
                                                    /Object.keys(data.data.jurries_list).length)%>
                                            </b>
                                        </p>
                                    </div>
                                    <div class="card small">
                                        <h2 style="color: #0050ec;">
                                            <%=data.data.reviewed%>
                                        </h2>
                                        <p>Total Reviewed</p>
                                    </div>
                                    <div class="card small">
                                        <h2 style="color: red;">
                                            <%=Number(data.data.pagecount) - Number(data.data.reviewed)%>
                                        </h2>
                                        <p>Remaining</p>
                                    </div>
                                    <div class="card big confidential">
                                        <h3>Jurries review count</h3>
                                        <ul id="reviewCount"></ul>
                                    </div>
                                    <!-- Group 1: Page and User Info -->
                                    <div class="card medium confidential">
                                        <h3>Page and User Info</h3>
                                        <p><i>Page Name:</i>
                                            <%= data.data.page_name ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>User Names:</i>
                                            <%= data.data.user_names ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Jurry Names:</i>
                                            <%= data.data.jurry_names ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Page Checker's Name:</i>
                                            <%= data.data['page_checker(s)_name'] ? 'Enabled' : 'Disabled' %>
                                        </p>
                                    </div>

                                    <!-- Group 2: Dates -->
                                    <div class="card medium confidential">
                                        <h3>Dates</h3>
                                        <p><i>Upload Date:</i>
                                            <%= data.data.upload_date ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Creation Date:</i>
                                            <%= data.data.creation_date ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>User Last Contribution Date:</i>
                                            <%= data.data.user_last_contribution_date ? 'Enabled' : 'Disabled' %>
                                        </p>
                                    </div>

                                    <!-- Group 3: Checks and Reviews -->
                                    <div class="card medium confidential">
                                        <h3>Checks and Reviews</h3>
                                        <p><i>User Edit Count:</i>
                                            <%= data.data.user_edit_count ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Single Checking:</i>
                                            <%= data.data.single_checking ? 'Enabled' : 'Disabled' %>
                                        </p>
                                    </div>

                                    <!-- Group 4: Feedback and Templates -->
                                    <div class="card medium confidential">
                                        <h3>Feedback and Templates</h3>
                                        <p><i>Send Feedback:</i>
                                            <%= data.data.send_feedback ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Feedback Template:</i>
                                            <%= data.data.feedback_template || 'N/A' %>
                                        </p>
                                    </div>

                                    <!-- Group 5: Text Options -->
                                    <div class="card medium confidential">
                                        <h3>Text Options</h3>
                                        <p><i>Add Text in Talk Page:</i>
                                            <%= data.data.add_text_in_talk_page ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Input Text 1:</i>
                                            <%= data.data['windowinp-input15-text1'] || 'N/A' %>
                                        </p>
                                        <p><i>Add Text in Main Pages:</i>
                                            <%= data.data.add_text_in_main_pages ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Input Text 2:</i>
                                            <%= data.data['windowinp-input16-text1'] || 'N/A' %>
                                        </p>
                                    </div>

                                    <!-- Group 6: Batch Operations and Statistics -->
                                    <div class="card medium confidential">
                                        <h3>Batch Operations and Statistics</h3>
                                        <p><i>Batch Upload:</i>
                                            <%= data.data.batch_upload ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Batch Review:</i>
                                            <%= data.data.batch_review ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Statistic:</i>
                                            <%= data.data.statistic ? 'Enabled' : 'Disabled' %>
                                        </p>
                                    </div>

                                    <!-- Group 7: Countdown and Select -->
                                    <div class="card medium confidential">
                                        <h3>Countdown and Window Select</h3>
                                        <p><i>Countdown:</i>
                                            <%= data.data.countdown ? 'Enabled' : 'Disabled' %>
                                        </p>
                                        <p><i>Result on basis of:</i>
                                            <%= data.data['result_makeing'] %>
                                        </p>
                                    </div>
                                    <script>
                                        document.getElementById("reviewCount").innerHTML = (Object.entries(userdata.data.jurries_list).map(e => {
                                            return `<li><a href='https://${userdata.data.base_component}.org/wiki/user:${e[0]}' title='User:${e[0]}'>${e[0]} : ${e[1].length}</a></li>`
                                        }).join(""));
                                    </script>
                                </div>
                                <div class="savecancle">
                                    <button class="save">Save</button>
                                    <button class="cancel">Cancel</button>
                                </div>
                                <div class="settings">
                                    <div class="card">
                                        <h3>List Page</h3>
                                        <p class="values">Current Value: <%=data.data.list_page || "not set" %>
                                        </p>
                                        <input data-properties='listed Page' type="text"
                                            value="<%=data.data.list_page%>" placeholder="Edit List Page">
                                    </div>
                                    <div class="card">
                                        <h3>Pre Condition</h3>
                                        <p class="values">Current Value: <%=data.data.pre_condition || "not set" %>
                                        </p>
                                        <input data-properties='Pre Condition' type="number"
                                            value="<%=data.data.pre_condition%>" placeholder="Edit Pre Condition">
                                    </div>
                                    <div class="card">
                                        <h3>Result</h3>
                                        <p class="values">Current Value: <%= data.data.result || "not set" %>
                                        </p>
                                        <input data-properties='Result' type="text" placeholder="Edit Result"
                                            value="<%= data.data.result %>">
                                    </div>
                                    <div class="card">
                                        <h3>Message Options</h3>
                                        <% if(data.data.send_feedback) {%>
                                            <p><b>Feedback Template:</b>
                                                <%= data.data.feedback_template || 'N/A' %>
                                            </p>
                                            <input type="text" data-properties="feedback template"
                                                value="<%= data.data.feedback_template %>">
                                            <% } %>
                                                <% if (data.data.add_text_in_talk_page) { %>

                                                    <p>
                                                        <b>Message for Talk Page:</b>
                                                        <%= data.data['windowinp-input15-text1'] || 'N/A' %>
                                                    </p>
                                                    <input type="text" data-properties="windowinp-input15-text1"
                                                        value="<%= data.data['windowinp-input15-text1']%>">
                                                    <% } %>
                                                        <%if(data.data.add_text_in_main_pages) { %>

                                                            <p>
                                                                <b>Message for main page:</b>
                                                                <%= data.data['windowinp-input16-text1'] || 'N/A' %>
                                                            </p>
                                                            <input type="text" data-properties="windowinp-input16-text1"
                                                                value="<%= data.data['windowinp-input16-text1']%>">

                                                            <% } %>

                                    </div>
                                    <div class="card">
                                        <h3>Start and End Date and Time</h3>
                                        <p class="values">Start Date Time : <%=(data.data.start_date || "not set" )
                                                + " | " + (data.data.start_time || "not set" ) %>
                                        </p>
                                        <div class="datetime"><input data-properties='Start date' type="date"
                                                value="<%=data.data.start_date%>">
                                            <input type="time" data-properties='Start time'
                                                value="<%=data.data.start_time%>">
                                        </div>
                                        <p class="values">End Date Time : <%=(data.data.end_date || "not set" ) + " | "
                                                + (data.data.end_time || "not set" ) %>
                                        </p>
                                        <div class="datetime"><input data-properties='End Date' type="date"
                                                value="<%= data.data.end_date %>">
                                            <input data-properties='End time' type="time"
                                                value="<%= data.data.end_time %>">
                                        </div>
                                    </div>
                                    <div class="card">
                                        <h3>Jurries</h3>
                                        <p class="values">Current Jurries:
                                        <ul id="Jurries"></ul>
                                        </p>
                                        <textarea data-properties='Jurries' placeholder="Edit Jury Details"
                                            rows="3"><%=data.data.jurries%></textarea>
                                    </div>
                                </div>
                                <script>
                                    const jurriesp = document.getElementById("Jurries");
                                    let jurrylist = JSON.parse(
                                        '["<%=data.data.jurries%>"]'.split(",").join('","')
                                    );
                                    jurriesp.innerHTML = jurrylist
                                        .map((e) => {
                                            return (
                                                "<li><a href='https://meta.wikimedia.org/wiki/User:" +
                                                encodeURIComponent(e) +
                                                "'>" +
                                                e +
                                                "</a></li>"
                                            );
                                        })
                                        .join("");
                                </script>
                                <% } else {%>
                                    <!-- The key file is corrupted, ask for delete it and create a new one -->
                                    <div id="overlay"></div>
                                    <div id="corruptedKeyPopup" class="popupMessage" style="display: none;">
                                        <h2>Corrupted Key File</h2>
                                        <p>Your key file is corrupted. Please delete it and create a new
                                            one.
                                        </p>
                                        <div>
                                            <button id="deleteKeyButton">Delete Key File</button>
                                            <button id="cancelButton">Contact support</button>
                                        </div>
                                    </div>
                                    <script>

                                        document.getElementById('corruptedKeyPopup').style.display = 'block';
                                        document.getElementById('overlay').style.display = 'block';
                                        document.getElementById('deleteKeyButton').addEventListener('click', function () {
                                            // Call API to delete the key file
                                            console.log(JSON.stringify({
                                                name: '<%= key %>',
                                                type: "key",
                                                user: USERNAME,
                                            }))
                                            deleteKey('<%= key %>')
                                        });

                                        document.getElementById('cancelButton').addEventListener('click', function () {
                                            document.getElementById('corruptedKeyPopup').style.display = 'none';
                                            document.getElementById('overlay').style.display = 'none';
                                        });

                                    </script>
                                    <% } %>
                                        <% }%>
                                            <% } %>
    </div>
</body>

</html>

</html>