const crypto=require("crypto"),fs=require("fs"),algorithm="aes-256-ecb",templatekey=Buffer.from("20eb74a29ce398e6dd4ea7b00bf1469b93c736657eed0ba16c79a8c796e97c51","hex");function writeFileOwn(e,t,i){let r=(new Date).toISOString();const n={createdAt:r,user:t,data:[],lastModified:r};fs.writeFile(e,JSON.stringify(n),(e=>{e||i()}))}function updateFileOwn(e,t,i){let r=__dirname+"./../../private/user/usr-"+encodeURIComponent(e)+".json",n=(new Date).toISOString();fs.stat(r,((l,a)=>{l?i(l):keepLog(e,a,"hosting",(e=>{e||fs.readFile(r,"utf8",((e,l)=>{if(e)i(e);else{const e=JSON.parse(l);e.lastModified=n,e.data.push(JSON.parse(t)),fs.writeFile(r,JSON.stringify(e),(e=>{e?i(e):i()}))}}))}))}))}function updateFile(e,t){fs.readFile(e,"utf8",((i,r)=>{if(i)t(i);else{const i=JSON.parse(r);t(null,i,((t,i)=>{fs.writeFile(e,JSON.stringify(t),(e=>{i(e||null)}))}))}}))}function readFile(e,t){fs.readFile(e,"utf8",((e,i)=>{e?t(e):t(null,JSON.parse(i))}))}function writeFile(e,t,i){fs.writeFile(e,t,{flag:"w+"},(e=>{i(e||null)}))}function deleteFile(e,t){fs.unlink(e,(function(e){e?t(e):t(null,{result:"Success"})}))}function uriEncript(e){const t=crypto.createCipheriv(algorithm,templatekey,null);let i=t.update(JSON.stringify(e),"utf8","hex");return i+=t.final("hex"),i}function uriDecript(e){const t=crypto.createDecipheriv(algorithm,templatekey,null);let i=t.update(e,"hex","utf8");return i+=t.final("utf8"),isValidJSON(i)}function isValidJSON(e){try{const t=JSON.parse(e);if("object"==typeof t&&null!==t)return t}catch(e){return!1}}function keepLog(e,t,i,r){const n=new Date,l=`${__dirname}/../../private/log/log-${n.getFullYear()}-${n.getMonth()+1}.json`;fs.stat(l,((a,u)=>{a?writeFile(l,JSON.stringify([{user:e,date:n.toString(),data:t,action:i}]),(e=>{r(e||null)})):updateFile(l,((l,a,u)=>{l?r(l):(a.push({user:e,date:n.toString(),data:t,action:i}),u(a,(e=>{r(e||null)})))}))}))}module.exports={writeFileOwn:writeFileOwn,updateFileOwn:updateFileOwn,updateFile:updateFile,uriEncript:uriEncript,uriDecript:uriDecript,readFile:readFile,writeFile:writeFile,deleteFile:deleteFile,keepLog:keepLog,stat:fs.stat};